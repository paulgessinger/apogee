{% from "macros.html" import status_to_class %}

{% with swap = true %}
{% include "notifications.html" %}
{% endwith %}

<nav class="pagination" role="navigation" aria-label="pagination">
	<a hx-boost="true" class="pagination-previous {{ 'is-disabled' if page == 1 else '' }}" {% if page > 1 -%}
		href="{{ url_for('pulls.index', page=page-1) }}"
		{%- endif %}>Previous</a>
	<a hx-boost="true" class="pagination-next {{ 'is-disabled' if page == num_pages else '' }}" {% if page < num_pages -%}
		href="{{ url_for('pulls.index', page=page+1) }}"
		{%- endif %}>Next page</a>
  <ul class="pagination-list">
		{% for i in range(1, num_pages+1) %}
    <li>
			<a hx-boost="true" href="{{ url_for('pulls.index', page=i) }}" class="pagination-link {{ 'is-current' if i == page else '' }}" aria-label="Goto page {{ i }}">{{ i }}</a>
    </li>
		{% endfor %}

  </ul>
</nav>

{% for pull in pulls|sort(attribute="updated_at", reverse=True) %}


<div class="box">

	<div class="columns">
		<div class="column">
			{% with pull = pull, status=latest_pipeline.status if latest_pipeline else none %}
				{% include "pull_title.html" %}
			{% endwith %}
		</div>
		<div class="column is-narrow">
			<div class="field is-grouped">
				{% if pull.patches|length > 0 %}
				<p class="control">
					<a class="button is-light is-warning"
						href="{{ url_for('edit_patches', pull=pull.number) }}">
						<span class="icon">
							<ion-icon name="bandage"></ion-icon>
						</span>
						<span>{{ pull.patches|length }}</span>
					</a>
				</p>
				{% endif %}

				<p class="control">
					<a class="button is-primary" hx-boost="true"
						href="{{ url_for('run_pipeline', pull=pull.number, back=request.url) }}">
						<span class="icon">
							<ion-icon name="rocket"></ion-icon>
						</span>
					</a>
				</p>

				<p class="control">
					<a class="button is-light" hx-boost="true"
						href="{{ url_for('pulls.show', number=pull.number) }}">
						<span class="icon">
							<ion-icon name="information-circle"></ion-icon>
						</span>
					</a>
				</p>
			</div>
		</div>
	</div>


	<span class="tags">
	{% set assocs = pull.commits | sort(attribute="order", reverse=True) %}
	{% for assoc in assocs[:] %}
	{% set latest_pipeline = assoc.commit.latest_pipeline %}
	<span class="tag {% if latest_pipeline -%}
			 {{ status_to_class(latest_pipeline.status) }} 
			 {% else -%}
			 is-light
			 {%- endif %}"
					x-tooltip.raw="{{ assoc.commit.sha }}">
					<a href="{{ url_for('commit_detail', sha=assoc.commit.sha, pull=pull.number) }}" hx-boost="true">{{ assoc.commit.sha[:9] }}</a>
				</span>
			{#{{ assoc.commit_sha }} - {{ assoc.commit.subject }} - {{ assoc.order }}<br>#}
	{% endfor %}
	</span>
	{#
	{% if assocs|length > 5 %}
	+ {{ assocs|length - 5 }} more
	{% endif %}
	#}

	{#
	{% set pipelines = pull.commit.pipelines|sort(attribute="created_at", reverse=True) %}
	{% if expanded %}
		{% for pipeline in pipelines %}
			{% with pipeline = pipeline, expanded = expanded and loop.first %}
					{% include "pipeline.html" %}
			{% endwith %}
			{% else %}
			No pipelines
		{% endfor %}
	{% else %}
		{% with pipeline = pipelines|first, expanded = False %}
				{% if pipeline is defined %}
				{% include "pipeline.html" %}
				{% else %}
				No pipelines
				{% endif %}
		{% endwith %}
	{% endif %}
	#}


</div>
	{% endfor %}

