{% from "macros.html" import status_to_class, relative_datetime %}

<div id="pipeline-{{ pipeline.id }}" class="box" x-data="{ expanded: {{ 'true' if expanded else 'false' }} }">
		<div class="columns">
			<div class="column">
				<p class="title is-7">
					<span class="tag {{ status_to_class(pipeline.status) }}">

						<a 
							x-tooltip.raw="{{ pipeline.status|upper }}"
							href="{{ pipeline.web_url }}">Pipeline #{{ pipeline.id }}</a>
					</span>
				</p>
				<p class="subtitle is-7">
					Created {{ relative_datetime(pipeline.created_at) }}
					{%- if pipeline.refreshed_at -%}
					, last updated {{ relative_datetime(pipeline.refreshed_at) }}
					{% endif %}
				</p>
			</div>
			<div class="column is-narrow">
				<div class="field is-grouped">
					<p class="control" x-data="{ clicked: false }">
						<button class="button" 
							:class="clicked ? 'is-loading' : ''"
							x-on:click="clicked = true"
							hx-post="{{ url_for("reload_pipeline", pipeline_id=pipeline.id) }}"
			 				hx-swap="outerHTML"
							hx-target="#pipeline-{{ pipeline.id }}"
							>
							<span class="icon"><ion-icon name="refresh-outline"></ion-icon></span>
							<span>Reload</span>
						</button>
					</p>
					<p class="control">
						<button class="button" @click="expanded = !expanded" x-html=" expanded ? 'Less' : 'More'"></button>
					</p>
				</div>
			</div>
		</div>
		{# hard code stages for now #}
		{#{% set stages = pipeline.jobs|map(attribute="stage")|list|sort|unique %}#}
		{% set stages = ["build", "test", "report"] %}


		<div class="block" x-show="expanded" x-collapse>
			<hr/>

			{% with variables = pipeline.variables %}
			{% include "variable_table.html" %}
			{% endwith %}

			<hr/>

			{% for stage in stages %}
			{{ stage }}
			{% set jobs = pipeline.jobs|selectattr("stage", "equalto", stage)|list %}

			<span class="tags">
				{% for job in jobs|sort(attribute="name") %}
				<span class="tag {{ status_to_class(job.status) }}"
				x-tooltip.raw="{{ job.status|upper }}">
					<a href="{{ job.web_url }}">{{ job.name }}</a>
				</span>
				{% endfor %}
			</span>
			{% endfor %}
		</div>

	</div>
